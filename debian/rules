#!/usr/bin/make -f

include /usr/share/cdbs/1/rules/debhelper.mk

PYTHON=/usr/bin/python
APXS2=/usr/bin/apxs2
APR_CONFIG=/usr/bin/apr-config
APU_CONFIG=/usr/bin/apu-config
UWSGI_BUILDER = $(CURDIR)/uwsgiconfig.py

UWSGI_PYTHON_PKG_KINDS = python python3

PYTHON_VERS=$(shell pyversions -vs)
PYTHON_DEFAULT=$(shell pyversions -dv)
PYTHON3_VERS=$(shell py3versions -vs)
PYTHON3_DEFAULT=$(shell py3versions -dv)

# List of templates to instantiate for each uwsgi-pythonX package
# There are special-case template, not listed here: dirs install manpages
UWSGI_PYTHON_PKG_TEMPLATES = default docs init.d init.d.custom logrotate \
                             postinst prerm README.Debian

# Search in debian/control for packages with name $(1)% and extract % in list.
list_pkgname_suffixes = $(strip \
	$(shell \
		grep "^Package: $(1)" $(CURDIR)/debian/control \
		| sed 's/Package: $(1)//' \
	) \
)

# List of packaged plugins' names
UWSGI_PLUGINS_NAMES = $(call list_pkgname_suffixes,uwsgi-plugin-)
UWSGI_PLUGINS_SRC_DIR = plugins

# List of packaged Apache2 modules' names
LIBAPACHE2_MODS_NAMES = uwsgi ruwsgi

ruwsgi_to_orig = $(subst ruwsgi,Ruwsgi,$(1))

# List of templates to instantiate for each libapache2-mod-X package
# There is special-case template, not listed here: uwsgi.load
LIBAPACHE2_MOD_PKG_TEMPLATES = install postinst prerm

COMMON_DOCS_COLLECTION_DIR = $(CURDIR)/debian/uwsgi-common-files/docs

# Discards directory-part of target and returns substring after last '-'
# character
target_name_tail = $(lastword $(subst -, ,$(notdir $(1))))

DEB_COMPRESS_EXCLUDE_uwsgi-common = .py .pl .xml .psgi .png
DEB_COMPRESS_EXCLUDE_uwsgi-extra = .class .java .rb .c

clean::
	# uWSGI executables
	$(RM) $(CURDIR)/uwsgi
	$(RM) $(addprefix $(CURDIR)/uwsgi-python, $(PYTHON_VERS))
	$(RM) $(addprefix $(CURDIR)/uwsgi-python, $(PYTHON3_VERS))
	# intermediate compiled files
	$(RM) $(CURDIR)/*.o $(CURDIR)/uwsgiconfig.pyc
	# plugins
	for PLUGIN_NAME in $(UWSGI_PLUGINS_NAMES); do \
		$(RM) $(CURDIR)/$${PLUGIN_NAME}_plugin.so; \
		$(RM) $(CURDIR)/$(UWSGI_PLUGINS_SRC_DIR)/$${PLUGIN_NAME}/uwsgiplugin.pyc; \
	done
	# compiled Apache2 modules
	$(RM) -r $(CURDIR)/apache2/.libs
	$(RM) -r $(addprefix $(CURDIR)/apache2/mod_, \
		$(foreach module_name, $(LIBAPACHE2_MODS_NAMES), \
			$(addprefix $(call ruwsgi_to_orig, $(module_name)), .la .lo .slo) \
	))
	# collected common docs
	$(RM) -r $(COMMON_DOCS_COLLECTION_DIR)
	# instantiated uwsgi-pythonX templates
	for TEMPLATE_TYPE in $(UWSGI_PYTHON_PKG_TEMPLATES) dirs install manpages; do\
		$(RM) $(addprefix $(CURDIR)/debian/uwsgi-, \
			$(addsuffix .$${TEMPLATE_TYPE}, $(UWSGI_PYTHON_PKG_KINDS)) \
		); \
	done
	# instantiated libapache2-mod-X templates
	for TEMPLATE_TYPE in $(LIBAPACHE2_MOD_PKG_TEMPLATES); do \
		$(RM) $(addprefix $(CURDIR)/debian/libapache2-mod-, \
			$(addsuffix .$${TEMPLATE_TYPE}, $(LIBAPACHE2_MODS_NAMES)) \
		); \
	done
	$(RM) $(addprefix $(CURDIR)/debian/, \
		$(foreach module_name, $(LIBAPACHE2_MODS_NAMES), \
			$(addsuffix .load,  $(call ruwsgi_to_orig, $(module_name))) \
	))
	# uwsgi-pythonX manpages
	$(RM) $(addprefix $(CURDIR)/debian/uwsgi-python, \
		$(addsuffix .8, $(PYTHON_VERS)) \
	)
	$(RM) $(addprefix $(CURDIR)/debian/uwsgi-python, \
		$(addsuffix .8, $(PYTHON3_VERS)) \
	)
	# instantiated uwsgi-plugin-N.install files
	$(RM) $(addprefix $(CURDIR)/debian/uwsgi-plugin-, \
		$(addsuffix .install, $(UWSGI_PLUGINS_NAMES)) \
	)
	# stampfiles
	$(RM) $(CURDIR)/debian/stamp-*

# Build uwsgi-python% package
$(patsubst %,build/uwsgi-%,$(UWSGI_PYTHON_PKG_KINDS)):: build/uwsgi-% : debian/stamp-uwsgi-%

# Build specific uwsgi-python/uwsgi-python3 package
$(patsubst %,debian/stamp-uwsgi-%,$(UWSGI_PYTHON_PKG_KINDS)):
	$(eval PYTHON_KIND = $(call target_name_tail, $@))
	$(eval UWSGI_PYTHON = uwsgi-$(PYTHON_KIND))
	$(eval PYVERS = $($(subst python,PYTHON,$(PYTHON_KIND))_VERS))
	for PYTHON_VERSION in $(PYVERS); do \
		$(PYTHON)$${PYTHON_VERSION} $(UWSGI_BUILDER) --build; \
		mv $(CURDIR)/uwsgi $(CURDIR)/uwsgi-python$${PYTHON_VERSION}; \
	done
	sed -e 's/@@uwsgi_binary@@/$(UWSGI_PYTHON)/g' \
		< $(CURDIR)/debian/uwsgi-python.dirs.in \
		> $(CURDIR)/debian/$(UWSGI_PYTHON).dirs
	touch $@

# Build uwsgi-plugin-% package
$(patsubst %,build/uwsgi-plugin-%,$(UWSGI_PLUGINS_NAMES)):: build/uwsgi-plugin-% : debian/stamp-plugin-%

# Build specific uWSGI plugin
$(patsubst %,debian/stamp-plugin-%,$(UWSGI_PLUGINS_NAMES)):
	$(eval PLUGIN_NAME = $(call target_name_tail, $@))
	$(PYTHON) $(UWSGI_BUILDER) --plugin $(UWSGI_PLUGINS_SRC_DIR)/$(PLUGIN_NAME)
	touch $@

# Build libapache2-mod-% package
$(patsubst %,build/libapache2-mod-%,$(LIBAPACHE2_MODS_NAMES)):: build/% : debian/stamp-%

# Build specific Apache2 module
$(patsubst %,debian/stamp-libapache2-mod-%,$(LIBAPACHE2_MODS_NAMES)):
	$(eval MODULE_NAME = $(call ruwsgi_to_orig, $(call target_name_tail, $@)))
	$(APXS2) -c \
		`$(APR_CONFIG) --link-ld` `$(APU_CONFIG) --link-ld` \
		$(CURDIR)/apache2/mod_$(MODULE_NAME).c
	touch $@

install/uwsgi-common::
	mkdir $(COMMON_DOCS_COLLECTION_DIR)
	cp -r $(CURDIR)/tests $(COMMON_DOCS_COLLECTION_DIR)
	for subdir in conffile psgi wsgi; do \
		mkdir -p $(COMMON_DOCS_COLLECTION_DIR)/examples/$$subdir; \
	done
	for file in logo_uWSGI.png myadmin.py simple_logger.py staticfilesnmp.py; do\
		cp $(CURDIR)/$$file $(COMMON_DOCS_COLLECTION_DIR)/examples; \
	done
	for file in mega.xml uwsgi.xml; do \
		cp $(CURDIR)/$$file $(COMMON_DOCS_COLLECTION_DIR)/examples/conffile; \
	done
	for file in mojoapp.pl psgi.py test.psgi; do \
		cp $(CURDIR)/$$file $(COMMON_DOCS_COLLECTION_DIR)/examples/psgi; \
	done
	for file in hello_world_rrdtool.py mjpeg_stream.py simple_app.py \
	            simple_app_wsgi2.py testapp.py ugreenchat.py uploadtest.py \
	            ; do \
		cp $(CURDIR)/$$file $(COMMON_DOCS_COLLECTION_DIR)/examples/wsgi; \
	done
	chmod a-x $(COMMON_DOCS_COLLECTION_DIR)/examples/wsgi/ugreenchat.py

# Install uwsgi-python% package
$(patsubst %,install/uwsgi-%,$(UWSGI_PYTHON_PKG_KINDS))::
	$(eval PYTHON_KIND = $(call target_name_tail, $@))
	$(eval PYVERS = $($(subst python,PYTHON,$(PYTHON_KIND))_VERS))
	$(eval PYDEFAULT = $($(subst python,PYTHON,$(PYTHON_KIND))_DEFAULT))
	for PYTHON_VERSION in $(PYVERS); do \
		for TEMPLATE_TYPE in install manpages; do \
			sed -e "s/@@uwsgi_binary@@/uwsgi-python$${PYTHON_VERSION}/g" \
				< $(CURDIR)/debian/uwsgi-python.$${TEMPLATE_TYPE}.in \
				>> $(CURDIR)/debian/$(cdbs_curpkg).$${TEMPLATE_TYPE}; \
		done; \
		help2man \
			--name 'fast (pure C), self-healing, developer-friendly WSGI server' \
			--section 8 \
			--no-info \
			$(CURDIR)/uwsgi-python$${PYTHON_VERSION} \
			> $(CURDIR)/debian/uwsgi-python$${PYTHON_VERSION}.8; \
	done
	for TEMPLATE_TYPE in $(UWSGI_PYTHON_PKG_TEMPLATES); do \
		sed \
			-e 's/@@uwsgi_binary@@/$(cdbs_curpkg)/g' \
			-e 's/@@available_python_versions@@/$(PYVERS)/g' \
			-e 's/@@default_python_version@@/$(PYDEFAULT)/g' \
				< $(CURDIR)/debian/uwsgi-python.$${TEMPLATE_TYPE}.in \
				> $(CURDIR)/debian/$(cdbs_curpkg).$${TEMPLATE_TYPE}; \
	done

# Install uwsgi-plugin-% package
$(patsubst %,install/uwsgi-plugin-%,$(UWSGI_PLUGINS_NAMES))::
	$(eval PLUGIN_NAME = $(call target_name_tail, $@))
	sed -e 's/@@plugin_name@@/$(PLUGIN_NAME)/g' \
		< $(CURDIR)/debian/uwsgi-plugin.install.in \
		> $(CURDIR)/debian/$(cdbs_curpkg).install

# Install libapache2-mod-% package
$(patsubst %,install/libapache2-mod-%,$(LIBAPACHE2_MODS_NAMES))::
	$(eval MODULE_NAME = $(call ruwsgi_to_orig, $(call target_name_tail, $@)))
	sed -e 's/@@module_name@@/$(MODULE_NAME)/g' \
		< $(CURDIR)/debian/uwsgi.load.in \
		> $(CURDIR)/debian/$(MODULE_NAME).load
	for TEMPLATE_TYPE in $(LIBAPACHE2_MOD_PKG_TEMPLATES); do \
		sed -e 's/@@module_name@@/$(MODULE_NAME)/g' \
			< $(CURDIR)/debian/libapache2-mod.$${TEMPLATE_TYPE}.in \
			> $(CURDIR)/debian/$(cdbs_curpkg).$${TEMPLATE_TYPE} ; \
	done

binary-install/python-django-uwsgi-admin::
	dh_install -p $(cdbs_curpkg) \
		django/uwsgi_admin \
		usr/lib/python$(PYTHON_DEFAULT)/dist-packages
	dh_pysupport -p $(cdbs_curpkg)

# Binary-post-install uwsgi-python% package
$(patsubst %,binary-post-install/uwsgi-%,$(UWSGI_PYTHON_PKG_KINDS))::
	$(eval SHAREDOCDIR = $(CURDIR)/debian/$(cdbs_curpkg)/usr/share/doc)
	sed -e 's/@@uwsgi_binary@@/$(cdbs_curpkg)/g' \
		< $(CURDIR)/debian/uwsgi-python.etc.README.in \
		> $(CURDIR)/debian/$(cdbs_curpkg)/etc/$(cdbs_curpkg)/README
	ln -s ../uwsgi-common/tests $(SHAREDOCDIR)/$(cdbs_curpkg)/tests
	ln -s ../uwsgi-common/examples $(SHAREDOCDIR)/$(cdbs_curpkg)/examples
