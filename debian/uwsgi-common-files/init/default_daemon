# This is shell script, (indirectly) sourced by uWSGI init.d script

. /usr/lib/uwsgi/init/snippets

# Return:
#  0 if daemon has been started
#  1 if daemon was already running
#  2 if daemon could not be started
do_start_default_daemon()
{
  install_dir $RUNDIR
  install_dir $DEFAULT_DAEMON_RUNDIR $UWSGI_UID $UWSGI_GID

  start-stop-daemon --start --quiet \
    --pidfile $DEFAULT_DAEMON_PIDFILE \
    --exec $DAEMON \
    --test > /dev/null \
      || return 1

  local DAEMON_ARGS=" \
    $DEFAULT_DAEMON_OPTS \
    --uid www-data \
    --gid www-data \
    --daemonize $LOGDIR/default_daemon.${LOG_FILENAME_SUFFIX}.log \
    --pidfile $DEFAULT_DAEMON_PIDFILE \
    --socket $DEFAULT_DAEMON_SOCKET \
  "
  start-stop-daemon --start --quiet \
    --pidfile $DEFAULT_DAEMON_PIDFILE \
    --exec $DAEMON -- $DAEMON_ARGS \
      || return 2

  chown_and_chmod_pidfile $DEFAULT_DAEMON_PIDFILE

  return 0
}

# Return:
#  0 if daemon has been stopped
#  1 if daemon was already stopped
#  2 if daemon could not be stopped
#  other if a failure occurred
do_stop_default_daemon()
{
  start-stop-daemon --stop --quiet \
    --retry=QUIT/30/KILL/5 \
    --pidfile $DEFAULT_DAEMON_PIDFILE \
    --name $NAME

  RETVAL="$?"
  [ "$RETVAL" = 2 ] && return 2

  rm -f $DEFAULT_DAEMON_PIDFILE
  rm -f $DEFAULT_DAEMON_SOCKET

  return "$RETVAL"
}

# Return:
#  0 if daemon has been reloaded
#  3 if daemon could not be reloaded
do_reload_default_daemon()
{
  start-stop-daemon --stop --quiet \
    --signal=HUP \
    --pidfile $DEFAULT_DAEMON_PIDFILE \
    --name $NAME

  RETVAL="$?"

  # There is no such process, nothing to reload!
  [ "$RETVAL" = 1 ] && RETVAL=3

  return "$RETVAL"
}

# Return:
#  0 if daemon has been reloaded
#  3 if daemon could not be reloaded
do_force_reload_default_daemon()
{
  start-stop-daemon --stop --quiet \
    --signal=TERM \
    --pidfile $DEFAULT_DAEMON_PIDFILE \
    --name $NAME

  RETVAL="$?"

  # There is no such process, nothing to reload!
  [ "$RETVAL" = 1 ] && RETVAL=3

  return "$RETVAL"
}
