# This is shell script, (indirectly) sourced by uWSGI init.d script

. /usr/lib/uwsgi/init/snippets

# Return:
#  0 if daemon has been started
#  1 if daemon was already running
#  2 if daemon could not be started
do_start_specific_daemon()
{
  local CONFNAME=$1

  local CONFFILE=$(path_to_conffile_with_name "$CONFNAME")
  if [ -z "$CONFFILE" ]; then
    return 2
  fi

  local UWSGI_UID=$(extract_id uid "$CONFNAME")
  local UWSGI_GID=$(extract_id gid "$CONFNAME")

  local SPECIFIC_RUNDIR=$(find_specific_rundir $CONFNAME)
  local PIDFILE=$(find_specific_pidfile $CONFNAME)
  local SOCKET=$(find_specific_socket $CONFNAME)

  install_dir $RUNDIR
  install_dir $UWSGI_RUNDIR
  install_dir $SPECIFIC_RUNDIR $UWSGI_UID $UWSGI_GID

  start-stop-daemon --start --quiet \
    --pidfile $PIDFILE \
    --exec $DAEMON \
    --test > /dev/null \
      || return 1

  local CONFFILE_OPTION_NAME
  local CONFTYPE=$(type_of_conffile "$CONFFILE")
  if [ "$CONFTYPE" = "ini" ]; then
    CONFFILE_OPTION_NAME=ini
  elif [ "$CONFTYPE" = "xml" ]; then
    CONFFILE_OPTION_NAME=xmlconfig
  fi

  local DAEMON_ARGS=" \
    $DAEMON_OPTS \
    --daemonize $UWSGI_LOGDIR/${CONFNAME}.${LOG_FILENAME_SUFFIX}.log \
    --pidfile $PIDFILE \
    --socket $SOCKET \
    --${CONFFILE_OPTION_NAME} $CONFFILE \
  "
  start-stop-daemon --start --quiet \
    --pidfile $PIDFILE \
    --exec $DAEMON -- $DAEMON_ARGS \
      || return 2

  chown_and_chmod_pidfile $PIDFILE

  return 0
}

# Return:
#  0 if daemon has been stopped
#  1 if daemon was already stopped
#  2 if daemon could not be stopped
#  other if a failure occurred
do_stop_specific_daemon()
{
  local CONFNAME=$1
  local SPECIFIC_RUNDIR=$(find_specific_rundir $CONFNAME)
  local PIDFILE=$(find_specific_pidfile $CONFNAME)

  start-stop-daemon --stop --quiet \
    --retry=QUIT/30/KILL/5 \
    --pidfile $PIDFILE \
    --name $NAME

  RETVAL="$?"
  [ "$RETVAL" = 2 ] && return 2

  rm -rf $SPECIFIC_RUNDIR

  return "$RETVAL"
}

# Return:
#  0 if daemon has been reloaded
#  3 if daemon could not be reloaded
do_reload_specific_daemon()
{
  local CONFNAME=$1
  local PIDFILE=$(find_specific_pidfile $CONFNAME)

  start-stop-daemon --stop --quiet \
    --signal=HUP \
    --pidfile $PIDFILE \
    --name $NAME

  RETVAL="$?"

  # There is no such process, nothing to reload!
  [ "$RETVAL" = 1 ] && RETVAL=3

  return "$RETVAL"
}

# Return:
#  0 if daemon has been reloaded
#  3 if daemon could not be reloaded
do_force_reload_specific_daemon()
{
  local CONFNAME=$1
  local PIDFILE=$(find_specific_pidfile $CONFNAME)

  start-stop-daemon --stop --quiet \
    --signal=TERM \
    --pidfile $PIDFILE \
    --name $NAME

  RETVAL="$?"

  # There is no such process, nothing to reload!
  [ "$RETVAL" = 1 ] && RETVAL=3

  return "$RETVAL"
}
